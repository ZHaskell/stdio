<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Std.IO.Resource</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Std-IO-Resource.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">stdio-0.1.0.0: Standard Input and Output for Haskell</p></div><div id="content"><div id="module-header"><table class="info"><tr><th valign="top">Copyright</th><td>(c) Winterland 2017</td></tr><tr><th>License</th><td>BSD</td></tr><tr><th>Maintainer</th><td>drkoster@qq.com</td></tr><tr><th>Stability</th><td>experimental</td></tr><tr><th>Portability</th><td>non-portable</td></tr><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Std.IO.Resource</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Resource management</a></li><li><a href="#g:2">Resource pool</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module also implements Gabriel Gonzalez'd idea on <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> applicative:
<a href="http://www.haskellforall.com/2013/06/the-resource-applicative.html">http://www.haskellforall.com/2013/06/the-resource-applicative.html</a>. The <code>Applicative</code> and <code>Monad</code> instance is
especially useful when you want safely combine multiple resources.</p><p>A high performance resource pool based on STM is also provided.</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">newtype</span> <a href="#t:Resource">Resource</a> a = <a href="#v:Resource">Resource</a> {<ul class="subs"><li><a href="#v:acquire">acquire</a> :: <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a> =&gt; IO (a, IO ())</li></ul>}</li><li class="src short"><a href="#v:initResource">initResource</a> :: IO a -&gt; (a -&gt; IO ()) -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</li><li class="src short"><a href="#v:initResource_">initResource_</a> :: IO () -&gt; IO () -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> ()</li><li class="src short"><a href="#v:withResource">withResource</a> :: (MonadMask m, MonadIO m, <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a>) =&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; (a -&gt; m b) -&gt; m b</li><li class="src short"><a href="#v:withResource-39-">withResource'</a> :: (MonadMask m, MonadIO m, <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a>) =&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; (a -&gt; m () -&gt; m b) -&gt; m b</li><li class="src short"><span class="keyword">data</span> <a href="#t:Pool">Pool</a> a</li><li class="src short"><span class="keyword">data</span> <a href="#t:PoolState">PoolState</a><ul class="subs"><li>= <a href="#v:PoolClosed">PoolClosed</a></li><li>| <a href="#v:PoolScanning">PoolScanning</a></li><li>| <a href="#v:PoolEmpty">PoolEmpty</a></li></ul></li><li class="src short"><a href="#v:initPool">initPool</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; Int -&gt; Int -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> (<a href="Std-IO-Resource.html#t:Pool">Pool</a> a)</li><li class="src short"><a href="#v:statPool">statPool</a> :: <a href="Std-IO-Resource.html#t:Pool">Pool</a> a -&gt; IO <a href="Std-IO-Resource.html#t:PoolState">PoolState</a></li><li class="src short"><a href="#v:initInPool">initInPool</a> :: <a href="Std-IO-Resource.html#t:Pool">Pool</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</li></ul></div><div id="interface"><h1 id="g:1">Resource management</h1><div class="top"><p class="src"><span class="keyword">newtype</span> <a id="t:Resource" class="def">Resource</a> a <a href="#t:Resource" class="selflink">#</a></p><div class="doc"><p>A <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> is an <code>IO</code> action which acquires some resource of type a and
 also returns a finalizer of type IO () that releases the resource.</p><p>The only safe way to use a <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> is <code><a href="Std-IO-Resource.html#v:withResource">withResource</a></code> / 'withResource\'',
 You should not use the <code><a href="Std-IO-Resource.html#v:acquire">acquire</a></code> field directly, unless you want to implement your own
 resource management. In the later case, you should always use <code>mask_</code> since
 some resource initializations may assume async exceptions are masked.</p><p><code>MonadIO</code> instance is provided so that you can lift <code>IO</code> computation inside
 <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code>, this is convenient for propagating <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> around since many
 <code>IO</code> computations carry finalizers.</p><p>A convention in stdio is that functions returning a <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> should be
 named in <code>initXXX</code> format, users are strongly recommended to follow this convention.</p><p>There're two additional guarantees we made in stdio:</p><ul><li>All resources in stdio can track its own liveness, throw <code><a href="Std-IO-Exception.html#t:ResourceVanished">ResourceVanished</a></code>
     exception using <code><a href="Std-IO-Exception.html#v:throwECLOSED">throwECLOSED</a></code> or <code><a href="Std-IO-Exception.html#v:throwECLOSEDSTM">throwECLOSEDSTM</a></code> when used after resource
     is closed.</li><li>All resources' clean up action in stdio is idempotent.</li></ul><p>Library authors providing <code>initXXX</code> are also encouraged to provide these guarantees.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Resource" class="def">Resource</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:acquire" class="def">acquire</a> :: <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a> =&gt; IO (a, IO ())</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div><div class="subs instances"><p id="control.i:Resource" class="caption collapser" onclick="toggleSection('i:Resource')">Instances</p><div id="section.i:Resource" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:Resource:Monad:1" class="instance expander" onclick="toggleSection('i:id:Resource:Monad:1')"></span> Monad <a href="Std-IO-Resource.html#t:Resource">Resource</a></span> <a href="#t:Resource" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:Resource:Monad:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-62--62--61-">(&gt;&gt;=)</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; (a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b) -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b</p><p class="src"><a href="#v:-62--62-">(&gt;&gt;)</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b</p><p class="src"><a href="#v:return">return</a> :: a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p><p class="src"><a href="#v:fail">fail</a> :: String -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p></div></div></td></tr><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:Resource:Functor:2" class="instance expander" onclick="toggleSection('i:id:Resource:Functor:2')"></span> Functor <a href="Std-IO-Resource.html#t:Resource">Resource</a></span> <a href="#t:Resource" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:Resource:Functor:2" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:fmap">fmap</a> :: (a -&gt; b) -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b</p><p class="src"><a href="#v:-60--36-">(&lt;$)</a> :: a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p></div></div></td></tr><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:Resource:Applicative:3" class="instance expander" onclick="toggleSection('i:id:Resource:Applicative:3')"></span> Applicative <a href="Std-IO-Resource.html#t:Resource">Resource</a></span> <a href="#t:Resource" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:Resource:Applicative:3" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:pure">pure</a> :: a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p><p class="src"><a href="#v:-60--42--62-">(&lt;*&gt;)</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> (a -&gt; b) -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b</p><p class="src"><a href="#v:-42--62-">(*&gt;)</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b</p><p class="src"><a href="#v:-60--42-">(&lt;*)</a> :: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> b -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p></div></div></td></tr><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:Resource:MonadIO:4" class="instance expander" onclick="toggleSection('i:id:Resource:MonadIO:4')"></span> MonadIO <a href="Std-IO-Resource.html#t:Resource">Resource</a></span> <a href="#t:Resource" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:Resource:MonadIO:4" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:liftIO">liftIO</a> :: IO a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:initResource" class="def">initResource</a> :: IO a -&gt; (a -&gt; IO ()) -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a <a href="#v:initResource" class="selflink">#</a></p><div class="doc"><p>Create <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> from create and release action.</p><p>Note, <code>resource</code> doesn't open resource itself, resource is created when you use
 <code>with</code> / <code>with'</code>.</p></div></div><div class="top"><p class="src"><a id="v:initResource_" class="def">initResource_</a> :: IO () -&gt; IO () -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> () <a href="#v:initResource_" class="selflink">#</a></p><div class="doc"><p>Create <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> from create and release action.</p><p>This function is useful when you want to add some initialization and clean up action
 inside <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code> monad.</p></div></div><div class="top"><p class="src"><a id="v:withResource" class="def">withResource</a> :: (MonadMask m, MonadIO m, <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a>) =&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; (a -&gt; m b) -&gt; m b <a href="#v:withResource" class="selflink">#</a></p><div class="doc"><p>Create a new resource and run some computation, resource is guarantee to
 be closed.</p><p>Be care don't leak the resource through computation return value, because
 after the computation finishes, the resource is closed already.</p></div></div><div class="top"><p class="src"><a id="v:withResource-39-" class="def">withResource'</a> :: (MonadMask m, MonadIO m, <a href="Std-IO-Exception.html#t:HasCallStack">HasCallStack</a>) =&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a -&gt; (a -&gt; m () -&gt; m b) -&gt; m b <a href="#v:withResource-39-" class="selflink">#</a></p><div class="doc"><p>Create a new resource and run some computation, resource is guarantee to
 be closed.</p><p>The difference from <code>with</code> is that the computation will receive an extra
 close action, which can be used to close the resource early before the whole
 computation finished, the close action can be called multiple times,
 only the first call will clean up the resource.</p></div></div><h1 id="g:2">Resource pool</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Pool" class="def">Pool</a> a <a href="#t:Pool" class="selflink">#</a></p><div class="doc"><p>A high performance resource pool based on STM.</p><p>We choose to not divide pool into strips due to the difficults in resource balancing. If there
 is a high contention on resource (see <code><a href="Std-IO-Resource.html#v:statPool">statPool</a></code>), just increase the maximum number of resources
 can be opened.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:PoolState" class="def">PoolState</a> <a href="#t:PoolState" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:PoolClosed" class="def">PoolClosed</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a id="v:PoolScanning" class="def">PoolScanning</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a id="v:PoolEmpty" class="def">PoolEmpty</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:PoolState" class="caption collapser" onclick="toggleSection('i:PoolState')">Instances</p><div id="section.i:PoolState" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:PoolState:Eq:1" class="instance expander" onclick="toggleSection('i:id:PoolState:Eq:1')"></span> Eq <a href="Std-IO-Resource.html#t:PoolState">PoolState</a></span> <a href="#t:PoolState" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:PoolState:Eq:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> :: <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; Bool</p><p class="src"><a href="#v:-47--61-">(/=)</a> :: <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; Bool</p></div></div></td></tr><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:PoolState:Show:2" class="instance expander" onclick="toggleSection('i:id:PoolState:Show:2')"></span> Show <a href="Std-IO-Resource.html#t:PoolState">PoolState</a></span> <a href="#t:PoolState" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:PoolState:Show:2" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: Int -&gt; <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; ShowS</p><p class="src"><a href="#v:show">show</a> :: <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> -&gt; String</p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Std-IO-Resource.html#t:PoolState">PoolState</a>] -&gt; ShowS</p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:initPool" class="def">initPool</a> <a href="#v:initPool" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Std-IO-Resource.html#t:Resource">Resource</a> a</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; Int</td><td class="doc"><p>maximum number of resources can be opened</p></td></tr><tr><td class="src">-&gt; Int</td><td class="doc"><p>amount of time after which an unused resource can be released (in seconds).</p></td></tr><tr><td class="src">-&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> (<a href="Std-IO-Resource.html#t:Pool">Pool</a> a)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Initialize a resource pool with given <code><a href="Std-IO-Resource.html#t:Resource">Resource</a></code></p><p>Like other initXXX functions, this function won't open a resource pool until you use <code><a href="Std-IO-Resource.html#v:withResource">withResource</a></code>.
 And this resource pool follow the same resource management pattern like other resources.</p></div></div><div class="top"><p class="src"><a id="v:statPool" class="def">statPool</a> :: <a href="Std-IO-Resource.html#t:Pool">Pool</a> a -&gt; IO <a href="Std-IO-Resource.html#t:PoolState">PoolState</a> <a href="#v:statPool" class="selflink">#</a></p><div class="doc"><p>Get a resource pool's <code><a href="Std-IO-Resource.html#t:PoolState">PoolState</a></code></p><p>This function is useful when debug, under load lots of <code><a href="Std-IO-Resource.html#v:PoolEmpty">PoolEmpty</a></code> may indicate
 contention on resources, i.e. the limit on maximum number of resources can be opened
 should be adjusted to a higher number. On the otherhand, lots of <code><a href="Std-IO-Resource.html#v:PoolScanning">PoolScanning</a></code>
 may indicate there're too much free resources.</p></div></div><div class="top"><p class="src"><a id="v:initInPool" class="def">initInPool</a> :: <a href="Std-IO-Resource.html#t:Pool">Pool</a> a -&gt; <a href="Std-IO-Resource.html#t:Resource">Resource</a> a <a href="#v:initInPool" class="selflink">#</a></p><div class="doc"><p>Obtain the pooled resource inside a given resource pool.</p><p>You shouldn't use <code><a href="Std-IO-Resource.html#v:withResource">withResource</a></code> with this resource after you closed the pool,
 an <code><a href="Std-IO-Exception.html#t:ResourceVanished">ResourceVanished</a></code> with <code>EPOOLCLOSED</code> name will be thrown.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.17.3</p></div></body></html>